"use strict";var _createClass=function(){function t(t,i){for(var e=0;e<i.length;e++){var n=i[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(i,e,n){return e&&t(i.prototype,e),n&&t(i,n),i}}();function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var Mention=function(){function t(i){_classCallCheck(this,t);this.options=i.options||[],this.input=i.input,this.reverse=i.reverse,this.symbol=i.symbol||"@",this.cursorPosition=0,this.hover=0,this.showingOptions=!1,this.upDownStay=0,this.wordAtCursor={},this.update=i.update||function(){},this.match=i.match||this.defaultMatchFunction,this.template=i.template||this.defaultTemplateFunction,this.html={input:void 0,display:void 0,wrapper:void 0,optionsList:void 0,options:[],spans:[]},this.setupHTML(),this.listen()}return _createClass(t,[{key:"defaultMatchFunction",value:function(t,i){var e=i.name||i;return!t.length||e.toLowerCase().startsWith(t.replace("@","").toLowerCase())}},{key:"defaultTemplateFunction",value:function(t){return t.name||t}},{key:"setupHTML",value:function(){this.html.input=this.input;var t=window.getComputedStyle(this.html.input,null),i=function(i){return parseInt((e=i,t.getPropertyValue(e)))||0;var e};for(var e in this.html.wrapper=document.createElement("div"),this.html.wrapper.classList.add("mention-wrapper"),this.html.wrapper.style.width=t.getPropertyValue("width"),this.html.input.parentElement.insertBefore(this.html.wrapper,this.html.input),this.html.textWrapper=document.createElement("div"),this.html.textWrapper.classList.add("mention-textwrapper"),this.html.wrapper.appendChild(this.html.textWrapper),this.html.display=document.createElement("div"),this.html.display.classList.add("mention-display"),this.html.textWrapper.appendChild(this.html.input),this.html.textWrapper.appendChild(this.html.display),t)try{this.html.display.style[e]=t[e]}catch(t){}this.html.display.style.padding=i("padding-top")+i("border-width")+"px",/iPhone|iPad|iPod|Edge/i.test(navigator.userAgent)&&(this.html.display.style.paddingLeft=i("padding-top")+i("border-width")+3+"px",navigator.userAgent.includes("Edge")&&(this.html.display.style.paddingTop=i("padding-top")+i("border-width")+3+"px")),this.html.display.style.wordBreak="break-word",this.html.display.style.wordWrap="break-word",this.html.display.style.background="transparent",this.html.display.style.border="none",this.html.display.style.pointerEvents="none",this.html.display.style.position="absolute",this.html.display.style.left="0px",this.html.display.style.top="0px",this.html.display.style.width="100%",this.html.input.style.width="100%",this.html.display.style.height="fit-content",this.html.optionsList=document.createElement("div"),this.html.optionsList.classList.add("mention-options"),this.html.wrapper.appendChild(this.html.optionsList),this.reverse&&(this.html.optionsList.classList.add("mention-options-reverse"),this.html.wrapper.insertBefore(this.html.optionsList,this.html.wrapper.firstChild));var n=!0,s=!1,o=void 0;try{for(var r,h=this.options[Symbol.iterator]();!(n=(r=h.next()).done);n=!0){var l=r.value,a=document.createElement("div");a.classList.add("mention-option"),a.innerHTML=this.template(l),a.setAttribute("mentiondata",JSON.stringify(l)),this.html.options.push(a),this.html.optionsList.appendChild(a)}}catch(t){s=!0,o=t}finally{try{!n&&h.return&&h.return()}finally{if(s)throw o}}}},{key:"listen",value:function(){var t=this;this.html.input.addEventListener("input",function(){t.onEventInput()}),this.html.input.addEventListener("keydown",function(i){t.onEventKeyDown(i)}),this.html.input.addEventListener("keyup",function(i){t.onEventKeyUp(i)}),this.html.textWrapper.addEventListener("scroll",function(i){t.onEventScroll(i)}),this.html.options.forEach(function(i){i.addEventListener("click",function(i){t.onEventOptionClick(i.target)})})}},{key:"onEventInput",value:function(){this.updateDisplay(),this.update()}},{key:"onEventKeyDown",value:function(t){if(this.upDownStay=40==t.keyCode?1:38==t.keyCode?-1:0,this.reverse&&(this.upDownStay*=-1),this.upDownStay&&this.showingOptions&&t.preventDefault(),13==t.keyCode&&this.showingOptions){t.preventDefault();var i=this.html.options.find(function(t){return t.classList.contains("hover")});i&&this.onEventOptionClick(i)}}},{key:"onEventKeyUp",value:function(){this.cursorPositionChanged(),this.setHoverOption()}},{key:"onEventOptionClick",value:function(t){var i=this.symbol+JSON.parse(t.getAttribute("mentiondata")).name+" ",e=this.html.input.value.split("");e.splice(this.wordAtCursor.index,this.wordAtCursor.word.length,i),this.html.input.value=e.join(""),this.html.input.focus(),this.setCursorPosition(this.wordAtCursor.index+i.length+1),this.updateDisplay(),this.toggleOptions(!1),this.update()}},{key:"onEventScroll",value:function(){}},{key:"cursorPositionChanged",value:function(){this.cursorPosition=this.html.input.selectionStart,this.wordAtCursor=this.readWordAtCursor({cursorPosition:this.cursorPosition,value:this.input.value}),this.toggleOptions(this.wordAtCursor.word.length&&this.wordAtCursor.word[0]==this.symbol),this.optionsMatch()}},{key:"updateDisplay",value:function(){this.html.display.innerHTML=this.convertInputValueToHTML();var t=window.getComputedStyle(this.html.input),i=parseInt(t.getPropertyValue("min-height"));i<this.html.display.offsetHeight&&(i=this.html.display.offsetHeight),this.html.input.style.height=i+"px"}},{key:"readWordAtCursor",value:function(t){for(var i="",e=t.cursorPosition,n=t.value.replace(/\n/g," ");e--;){if(" "==n[e]||e<0)break}for(;e++<n.length-1;){var s=n[e];if(" "==s)break;i+=s}return{index:Math.max(e-i.length,0),word:i}}},{key:"toggleOptions",value:function(t){this.html.optionsList.classList.remove("show"),t&&this.html.optionsList.classList.add("show"),this.showingOptions=t}},{key:"optionsMatch",value:function(){for(var t in this.options){var i=this.wordAtCursor.word.replace("@","");this.html.options[t].classList.remove("show"),this.match(i,this.options[t])&&this.html.options[t].classList.add("show")}}},{key:"setHoverOption",value:function(){var t=this.html.options.filter(function(t){return t.classList.remove("hover"),t.classList.contains("show")});t.length?(this.hover=this.upDownStay?this.hover+this.upDownStay:0,this.hover<0&&(this.hover=t.length-1),this.hover==t.length&&(this.hover=0),t[this.hover].classList.add("hover")):this.toggleOptions(!1)}},{key:"setCursorPosition",value:function(t){this.cursorPosition=t,this.html.input.setSelectionRange(t,t)}},{key:"collect",value:function(){var t=[],i=this.html.display.querySelectorAll("u"),e=!0,n=!1,s=void 0;try{for(var o,r=i[Symbol.iterator]();!(e=(o=r.next()).done);e=!0){var h=o.value;t.push(JSON.parse(h.getAttribute("mentiondata")))}}catch(t){n=!0,s=t}finally{try{!e&&r.return&&r.return()}finally{if(n)throw s}}return t}},{key:"convertInputValueToHTML",value:function(){var t=this.findMatches(),i=this.html.input.value.split(""),e=!0,n=!1,s=void 0;try{for(var o,r=t[Symbol.iterator]();!(e=(o=r.next()).done);e=!0){var h=o.value,l=!0,a=!1,p=void 0;try{for(var u,d=this.options[Symbol.iterator]();!(l=(u=d.next()).done);l=!0){var c=u.value;if(this.symbol+(c.name||c)==h.word){var m=document.createElement("u");m.innerHTML=h.word,m.setAttribute("mentiondata",JSON.stringify(c)),i.splice(h.index,h.word.length,m.outerHTML)}}}catch(t){a=!0,p=t}finally{try{!l&&d.return&&d.return()}finally{if(a)throw p}}}}catch(t){n=!0,s=t}finally{try{!e&&r.return&&r.return()}finally{if(n)throw s}}return"\n"==(i=i.join(""))[i.length-1]&&(i+=" "),i}},{key:"findMatches",value:function(){var t=this.html.input.value.split("").concat([" "]),i=[],e="";for(var n in t){var s=t[n],o=t[n-1]||" ",r=[" ","\\n"].indexOf(o)>-1||10==o.charCodeAt(0);(s.includes(this.symbol)&&r||e.length)&&" "!=s&&(e+=s),e.length&&" "==s&&(i.unshift({word:e,index:Math.max(n-e.length,0)}),e="")}return i}},{key:"numStyle",value:function(t,i){var e=window.getComputedStyle(t);return parseInt(e.getPropertyValue(i))}},{key:"deconctruct",value:function(){}}]),t}();"undefined"!=typeof module&&(module.exports=Mention);