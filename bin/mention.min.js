"use strict";var _createClass=function(){function t(t,i){for(var e=0;e<i.length;e++){var s=i[e];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(i,e,s){return e&&t(i.prototype,e),s&&t(i,s),i}}();function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var Mention=function(){function t(i){_classCallCheck(this,t);this.options=i.options||[],this.input=i.input,this.reverse=i.reverse,this.symbol=i.symbol||"@",this.cursorPosition=0,this.hover=0,this.showingOptions=!1,this.upDownStay=0,this.wordAtCursor={},this.update=i.update||function(){},this.match=i.match||this.defaultMatchFunction,this.template=i.template||this.defaultTemplateFunction,this.html={input:void 0,display:void 0,wrapper:void 0,optionsList:void 0,options:[],spans:[]},this.setupHTML(),this.listen()}return _createClass(t,[{key:"defaultMatchFunction",value:function(t,i){var e=i.name||i;return!t.length||e.startsWith(t.replace("@",""))}},{key:"defaultTemplateFunction",value:function(t){return t.name||t}},{key:"setupHTML",value:function(){this.html.input=this.input;var t=window.getComputedStyle(this.html.input,"");for(var i in this.html.wrapper=document.createElement("div"),this.html.wrapper.classList.add("mention-wrapper"),this.html.wrapper.style.position="relative",this.html.wrapper.style.width=t.getPropertyValue("width"),this.html.display=document.createElement("div"),this.html.display.classList.add("mention-display"),this.html.input.parentElement.insertBefore(this.html.wrapper,this.html.input),this.html.wrapper.appendChild(this.html.input),this.html.wrapper.appendChild(this.html.display),t)try{this.html.display.style[i]=t[i]}catch(t){}/iPhone|iPad|iPod|Edge/i.test(navigator.userAgent)&&(this.html.display.style.paddingLeft=parseInt(t.getPropertyValue("padding-left"))+3+"px",navigator.userAgent.includes("Edge")&&(this.html.display.style.paddingTop=parseInt(t.getPropertyValue("padding-top"))+3+"px")),this.html.display.style.wordBreak="break-word",this.html.display.style.wordWrap="break-word",this.html.display.style.background="transparent",this.html.display.style.pointerEvents="none",this.html.display.style.position="absolute",this.html.display.style.left="0px",this.html.display.style.top="0px",this.html.display.style.width="100%",this.html.input.style.width="100%",this.html.display.style.height="fit-content",this.html.optionsList=document.createElement("div"),this.html.optionsList.classList.add("mention-options"),this.html.wrapper.appendChild(this.html.optionsList),this.reverse&&(this.html.optionsList.classList.add("mention-options-reverse"),this.html.wrapper.insertBefore(this.html.optionsList,this.html.wrapper.firstChild));var e=!0,s=!1,n=void 0;try{for(var o,r=this.options[Symbol.iterator]();!(e=(o=r.next()).done);e=!0){var h=o.value,a=document.createElement("div");a.classList.add("mention-option"),a.innerHTML=this.template(h),a.setAttribute("mentiondata",JSON.stringify(h)),this.html.options.push(a),this.html.optionsList.appendChild(a)}}catch(t){s=!0,n=t}finally{try{!e&&r.return&&r.return()}finally{if(s)throw n}}}},{key:"listen",value:function(){var t=this;this.html.input.addEventListener("input",function(){t.onEventInput()}),this.html.input.addEventListener("keydown",function(i){t.onEventKeyDown(i)}),this.html.input.addEventListener("keyup",function(i){t.onEventKeyUp(i)}),this.html.options.forEach(function(i){i.addEventListener("click",function(i){t.onEventOptionClick(i.target)})})}},{key:"onEventInput",value:function(){this.updateDisplay(),this.update()}},{key:"onEventKeyDown",value:function(t){this.upDownStay=40==t.keyCode?1:38==t.keyCode?-1:0,this.reverse&&(this.upDownStay*=-1),this.upDownStay&&this.showingOptions&&t.preventDefault(),13==t.keyCode&&this.showingOptions&&(t.preventDefault(),this.onEventOptionClick(this.html.options.find(function(t){return t.classList.contains("hover")})))}},{key:"onEventKeyUp",value:function(){this.cursorPositionChanged(),this.setHoverOption()}},{key:"onEventOptionClick",value:function(t){var i=this.symbol+JSON.parse(t.getAttribute("mentiondata")).name+" ",e=this.html.input.value.split("");e.splice(this.wordAtCursor.index,this.wordAtCursor.word.length,i),this.html.input.value=e.join(""),this.html.input.focus(),this.setCursorPosition(this.wordAtCursor.index+i.length+1),this.updateDisplay(),this.toggleOptions(!1),this.update()}},{key:"cursorPositionChanged",value:function(){this.cursorPosition=this.html.input.selectionStart,this.wordAtCursor=this.readWordAtCursor({cursorPosition:this.cursorPosition,value:this.input.value}),this.toggleOptions(this.wordAtCursor.word.length&&this.wordAtCursor.word[0]==this.symbol),this.optionsMatch()}},{key:"updateDisplay",value:function(){this.html.display.innerHTML=this.convertInputValueToHTML();var t=window.getComputedStyle(this.html.input),i=parseInt(t.getPropertyValue("min-height"));i+=parseInt(t.getPropertyValue("padding-bottom")),(i+=parseInt(t.getPropertyValue("border-width"))/2)<this.html.display.offsetHeight&&(i=this.html.display.offsetHeight),this.html.input.style.height=i+"px"}},{key:"readWordAtCursor",value:function(t){for(var i="",e=t.cursorPosition,s=t.value.replace(/\n/g," ");e--;){if(" "==s[e]||e<0)break}for(;e++<s.length-1;){var n=s[e];if(" "==n)break;i+=n}return{index:Math.max(e-i.length,0),word:i}}},{key:"toggleOptions",value:function(t){this.html.optionsList.classList.remove("show"),t&&this.html.optionsList.classList.add("show"),this.showingOptions=t}},{key:"optionsMatch",value:function(){for(var t in this.options){var i=this.wordAtCursor.word.replace("@","");this.html.options[t].classList.remove("show"),this.match(i,this.options[t])&&this.html.options[t].classList.add("show")}}},{key:"setHoverOption",value:function(){var t=this.html.options.filter(function(t){return t.classList.remove("hover"),t.classList.contains("show")});t.length&&(this.hover=this.upDownStay?this.hover+this.upDownStay:this.reverse?t.length-1:0,console.log(this.hover),this.hover<0&&(this.hover=t.length-1),this.hover==t.length&&(this.hover=0),t[this.hover].classList.add("hover"))}},{key:"setCursorPosition",value:function(t){this.cursorPosition=t,this.html.input.setSelectionRange(t,t)}},{key:"collect",value:function(){var t=[],i=this.html.display.querySelectorAll("u"),e=!0,s=!1,n=void 0;try{for(var o,r=i[Symbol.iterator]();!(e=(o=r.next()).done);e=!0){var h=o.value;t.push(JSON.parse(h.getAttribute("mentiondata")))}}catch(t){s=!0,n=t}finally{try{!e&&r.return&&r.return()}finally{if(s)throw n}}return t}},{key:"convertInputValueToHTML",value:function(){var t=this.findMatches(),i=this.html.input.value.split(""),e=!0,s=!1,n=void 0;try{for(var o,r=t[Symbol.iterator]();!(e=(o=r.next()).done);e=!0){var h=o.value,a=!0,l=!1,p=void 0;try{for(var u,d=this.options[Symbol.iterator]();!(a=(u=d.next()).done);a=!0){var c=u.value;if(this.symbol+(c.name||c)==h.word){var m=document.createElement("u");m.innerHTML=h.word,m.setAttribute("mentiondata",JSON.stringify(c)),i.splice(h.index,h.word.length,m.outerHTML)}}}catch(t){l=!0,p=t}finally{try{!a&&d.return&&d.return()}finally{if(l)throw p}}}}catch(t){s=!0,n=t}finally{try{!e&&r.return&&r.return()}finally{if(s)throw n}}return" "!=(i=i.join(""))[i.length-1]&&(i+="&nbsp;"),i}},{key:"findMatches",value:function(){var t=this.html.input.value.split("").concat([" "]),i=[],e="";for(var s in t){var n=t[s],o=t[s-1]||" ",r=[" ","\\n"].indexOf(o)>-1||10==o.charCodeAt(0);(n.includes(this.symbol)&&r||e.length)&&" "!=n&&(e+=n),e.length&&" "==n&&(i.unshift({word:e,index:Math.max(s-e.length,0)}),e="")}return i}},{key:"deconctruct",value:function(){}}]),t}();"undefined"!=typeof module&&(module.exports=Mention);