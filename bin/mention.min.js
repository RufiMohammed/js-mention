"use strict";var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var Mention=function(){function t(e){_classCallCheck(this,t);this.options=e.options||[],this.input=e.input,this.reverse=e.reverse,this.symbol=e.symbol||"@",this.cursorPosition=0,this.hover=0,this.showingOptions=!1,this.upDownStay=0,this.wordAtCursor={},this.update=e.update||function(){},this.match=e.match||this.defaultMatchFunction,this.template=e.template||this.defaultTemplateFunction,this.html={input:void 0,display:void 0,wrapper:void 0,optionsList:void 0,options:[],spans:[]},this.setupHTML(),this.listen()}return _createClass(t,[{key:"defaultMatchFunction",value:function(t,e){var i=e.name||e;return!t.length||i.toLowerCase().startsWith(t.replace("@","").toLowerCase())}},{key:"defaultTemplateFunction",value:function(t){return t.name||t}},{key:"setupHTML",value:function(){this.html.input=this.input;var t=window.getComputedStyle(this.html.input,""),e=function(e){return parseInt((i=e,t.getPropertyValue(i)));var i};for(var i in this.html.wrapper=document.createElement("div"),this.html.wrapper.classList.add("mention-wrapper"),this.html.wrapper.style.width=t.getPropertyValue("width"),this.html.input.parentElement.insertBefore(this.html.wrapper,this.html.input),this.html.textWrapper=document.createElement("div"),this.html.textWrapper.classList.add("mention-textwrapper"),this.html.wrapper.appendChild(this.html.textWrapper),this.html.display=document.createElement("div"),this.html.display.classList.add("mention-display"),this.html.textWrapper.appendChild(this.html.input),this.html.textWrapper.appendChild(this.html.display),t)try{this.html.display.style[i]=t[i]}catch(t){}/iPhone|iPad|iPod|Edge/i.test(navigator.userAgent)&&(this.html.display.style.paddingLeft=parseInt(t.getPropertyValue("padding-left"))+3+"px",navigator.userAgent.includes("Edge")&&(this.html.display.style.paddingTop=parseInt(t.getPropertyValue("padding-top"))+3+"px")),this.html.display.style.padding=e("padding-top")+e("border-width")+"px",this.html.display.style.wordBreak="break-word",this.html.display.style.wordWrap="break-word",this.html.display.style.background="transparent",this.html.display.style.border="none",this.html.display.style.pointerEvents="none",this.html.display.style.position="absolute",this.html.display.style.left="0px",this.html.display.style.top="0px",this.html.display.style.width="100%",this.html.input.style.width="100%",this.html.display.style.height="fit-content",this.html.optionsList=document.createElement("div"),this.html.optionsList.classList.add("mention-options"),this.html.wrapper.appendChild(this.html.optionsList),this.reverse&&(this.html.optionsList.classList.add("mention-options-reverse"),this.html.wrapper.insertBefore(this.html.optionsList,this.html.wrapper.firstChild));var n=!0,s=!1,o=void 0;try{for(var r,h=this.options[Symbol.iterator]();!(n=(r=h.next()).done);n=!0){var a=r.value,l=document.createElement("div");l.classList.add("mention-option"),l.innerHTML=this.template(a),l.setAttribute("mentiondata",JSON.stringify(a)),this.html.options.push(l),this.html.optionsList.appendChild(l)}}catch(t){s=!0,o=t}finally{try{!n&&h.return&&h.return()}finally{if(s)throw o}}}},{key:"listen",value:function(){var t=this;this.html.input.addEventListener("input",function(){t.onEventInput()}),this.html.input.addEventListener("keydown",function(e){t.onEventKeyDown(e)}),this.html.input.addEventListener("keyup",function(e){t.onEventKeyUp(e)}),this.html.textWrapper.addEventListener("scroll",function(e){t.onEventScroll(e)}),this.html.options.forEach(function(e){e.addEventListener("click",function(e){t.onEventOptionClick(e.target)})})}},{key:"onEventInput",value:function(){this.updateDisplay(),this.update()}},{key:"onEventKeyDown",value:function(t){if(this.upDownStay=40==t.keyCode?1:38==t.keyCode?-1:0,this.reverse&&(this.upDownStay*=-1),this.upDownStay&&this.showingOptions&&t.preventDefault(),13==t.keyCode&&this.showingOptions){t.preventDefault();var e=this.html.options.find(function(t){return t.classList.contains("hover")});e&&this.onEventOptionClick(e)}}},{key:"onEventKeyUp",value:function(){this.cursorPositionChanged(),this.setHoverOption()}},{key:"onEventOptionClick",value:function(t){var e=this.symbol+JSON.parse(t.getAttribute("mentiondata")).name+" ",i=this.html.input.value.split("");i.splice(this.wordAtCursor.index,this.wordAtCursor.word.length,e),this.html.input.value=i.join(""),this.html.input.focus(),this.setCursorPosition(this.wordAtCursor.index+e.length+1),this.updateDisplay(),this.toggleOptions(!1),this.update()}},{key:"onEventScroll",value:function(){}},{key:"cursorPositionChanged",value:function(){this.cursorPosition=this.html.input.selectionStart,this.wordAtCursor=this.readWordAtCursor({cursorPosition:this.cursorPosition,value:this.input.value}),this.toggleOptions(this.wordAtCursor.word.length&&this.wordAtCursor.word[0]==this.symbol),this.optionsMatch()}},{key:"updateDisplay",value:function(){this.html.display.innerHTML=this.convertInputValueToHTML();var t=window.getComputedStyle(this.html.input),e=parseInt(t.getPropertyValue("min-height"));e<this.html.display.offsetHeight&&(e=this.html.display.offsetHeight),this.html.input.style.height=e+"px"}},{key:"readWordAtCursor",value:function(t){for(var e="",i=t.cursorPosition,n=t.value.replace(/\n/g," ");i--;){if(" "==n[i]||i<0)break}for(;i++<n.length-1;){var s=n[i];if(" "==s)break;e+=s}return{index:Math.max(i-e.length,0),word:e}}},{key:"toggleOptions",value:function(t){this.html.optionsList.classList.remove("show"),t&&this.html.optionsList.classList.add("show"),this.showingOptions=t}},{key:"optionsMatch",value:function(){for(var t in this.options){var e=this.wordAtCursor.word.replace("@","");this.html.options[t].classList.remove("show"),this.match(e,this.options[t])&&this.html.options[t].classList.add("show")}}},{key:"setHoverOption",value:function(){var t=this.html.options.filter(function(t){return t.classList.remove("hover"),t.classList.contains("show")});t.length?(this.hover=this.upDownStay?this.hover+this.upDownStay:0,this.hover<0&&(this.hover=t.length-1),this.hover==t.length&&(this.hover=0),t[this.hover].classList.add("hover")):this.toggleOptions(!1)}},{key:"setCursorPosition",value:function(t){this.cursorPosition=t,this.html.input.setSelectionRange(t,t)}},{key:"collect",value:function(){var t=[],e=this.html.display.querySelectorAll("u"),i=!0,n=!1,s=void 0;try{for(var o,r=e[Symbol.iterator]();!(i=(o=r.next()).done);i=!0){var h=o.value;t.push(JSON.parse(h.getAttribute("mentiondata")))}}catch(t){n=!0,s=t}finally{try{!i&&r.return&&r.return()}finally{if(n)throw s}}return t}},{key:"convertInputValueToHTML",value:function(){var t=this.findMatches(),e=this.html.input.value.split(""),i=!0,n=!1,s=void 0;try{for(var o,r=t[Symbol.iterator]();!(i=(o=r.next()).done);i=!0){var h=o.value,a=!0,l=!1,p=void 0;try{for(var u,d=this.options[Symbol.iterator]();!(a=(u=d.next()).done);a=!0){var c=u.value;if(this.symbol+(c.name||c)==h.word){var m=document.createElement("u");m.innerHTML=h.word,m.setAttribute("mentiondata",JSON.stringify(c)),e.splice(h.index,h.word.length,m.outerHTML)}}}catch(t){l=!0,p=t}finally{try{!a&&d.return&&d.return()}finally{if(l)throw p}}}}catch(t){n=!0,s=t}finally{try{!i&&r.return&&r.return()}finally{if(n)throw s}}return"\n"==(e=e.join(""))[e.length-1]&&(e+=" "),e}},{key:"findMatches",value:function(){var t=this.html.input.value.split("").concat([" "]),e=[],i="";for(var n in t){var s=t[n],o=t[n-1]||" ",r=[" ","\\n"].indexOf(o)>-1||10==o.charCodeAt(0);(s.includes(this.symbol)&&r||i.length)&&" "!=s&&(i+=s),i.length&&" "==s&&(e.unshift({word:i,index:Math.max(n-i.length,0)}),i="")}return e}},{key:"numStyle",value:function(t,e){var i=window.getComputedStyle(t);return parseInt(i.getPropertyValue(e))}},{key:"deconctruct",value:function(){}}]),t}();"undefined"!=typeof module&&(module.exports=Mention);